<!DOCTYPE html>
<html>
<head>
    <title>Route Finder</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDVS9S2Txb-yhzTW2YkB7ZSSIMUw5EIGsU&libraries=places"></script>
</head>
<body>
    <h1>Route Finder</h1>
    <form id="route-form">
        <label for="start">Start Location:</label>
        <input type="text" id="start" placeholder="Enter start location">
        <br>
        <label for="end">End Location:</label>
        <input type="text" id="end" placeholder="Enter end location">
        <br>
        <button type="submit">Find Route</button>
    </form>

    <input type="file" id="fileInput" accept=".txt">
    <pre id="output"></pre>
<!-- <button onclick="addMarkersFromFile()">Add Markers from File</button> -->
    

    <div id="map" style="height: 400px; width: 100%;"></div>
    <div id="dynamicContentContainer"></div>
    
    <script>
        var waypointsArr = [{ location: 'Weston Hall, Manchester', stopover: false },
                            { location: 'Manchester Astronomical Society', stopover: false }]
                            
        var map;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: new google.maps.LatLng(53.4808, -2.2384),
                zoom: 12
            });
        }

        initMap();

        function displayRoute(destination, colour){
            return new Promise(function (resolve, reject) { 
            var start = document.getElementById('start').value;
            var end = destination;

            var directionsService = new google.maps.DirectionsService();
            var directionsDisplay = new google.maps.DirectionsRenderer({
                map: map,
                polylineOptions:{
                    strokeColor: colour, 
                    strokeOpacity: 0.8,
                }
            });
            directionsService.route({
                origin: 'Kilburn Building, Manchester',
                destination: end,
                waypoints: waypointsArr,
                optimizeWaypoints: true,
                travelMode: 'DRIVING'
            }, function (response, status) {
                if (status === 'OK') {
                    directionsDisplay.setDirections(response);
                    valuesArr = [];
                    const route = response.routes[0].legs[0];
                    const totalDistance = route.distance.value; // in meters

                    // Specify the number of waypoints you want
                    const numWaypoints = 20;
                    const interval = totalDistance / numWaypoints;

                    // Calculate and extract evenly spaced waypoints
                    for (let i = 0; i < numWaypoints; i++) {
                    const distanceAlongRoute = i * interval;
                    const location = getWaypointLocation(route, distanceAlongRoute);
                    valuesArr.push(location);
                    }
                    resolve(valuesArr);
                } else {
                    reject(window.alert('Directions request failed due to ' + status));
                }
            }); 
            });
        }

        function getWaypointLocation(route, distance) {
            let currentDistance = 0;

            // Iterate through the steps of the route to find the correct segment
            for (const step of route.steps) {
                const stepDistance = step.distance.value;

                if (currentDistance + stepDistance > distance) {
                const fraction = (distance - currentDistance) / stepDistance;
                const lat = step.start_location.lat() + fraction * (step.end_location.lat() - step.start_location.lat());
                const lng = step.start_location.lng() + fraction * (step.end_location.lng() - step.start_location.lng());

                return { lat, lng };
                }

                currentDistance += stepDistance;
            }

            // If the distance is beyond the route, return the destination
            return { lat: route.end_location.lat(), lng: route.end_location.lng() };
        }

        function addMarkersFromFile() {
            return new Promise((resolve, reject) => {
                var fileInput = document.getElementById('fileInput');
                var file = fileInput.files[0];

                if (file) {
                    var reader = new FileReader();

                    reader.onload = async function(e) {

                        try {
                        var content = e.target.result;
                        var locations = parseFileContent(content);
                        let final = await drawRoute(locations);
                        resolve(final);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsText(file);
                } else {
                    reject("No file selected.");
                }
            });
        }


        function parseFileContent(content) {
        // You need to implement a parser that extracts latitude, longitude, and any other necessary data from the file content.
            var locations = [];
            var lines = content.split('\n');

            for (var i = 0; i < lines.length; i++) {
                firstChar = lines[i][0];
                if (firstChar != "-"){
                    continue;
                }
                var parts = lines[i].split('>');
                var waypoint = parts[0].trimEnd();
                var stats = parts[1].replace(/\(|\)/g, '');
                stats = stats.split(',');

                if (parts.length === 2) {
                    var lat = parseFloat(stats[0].trim());
                    var lng = parseFloat(stats[1].trim());

                    if (!isNaN(lat) && !isNaN(lng)) {
                        locations.push({ lat: lat, lng: lng });
                    }
                }
                
            }

            return locations;
        }

        function drawRoute(locations) {
            return new Promise(function (resolve) { 
            if (locations.length < 2) {
                alert('At least two waypoints are required for a route.');
                return;
            }

            var waypoints = locations.map(function(location) {
                return {
                location: { lat: location.lat, lng: location.lng },
                stopover: false
                };
            });

           waypoints = waypoints.slice(0, -1).concat(waypointsArr, waypoints.slice(-1));

            var directionsService = new google.maps.DirectionsService();
            var request = {
                origin: waypoints[0].location,
                destination: waypoints[waypoints.length - 1].location,
                waypoints: waypoints.slice(1, waypoints.length - 1),
                optimizeWaypoints: true,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function(result, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                var directionsDisplay = new google.maps.DirectionsRenderer({
                    map: map,
                    polylineOptions: {
                    strokeColor: 'blue', // Change the color here
                    }
                });
                directionsDisplay.setDirections(result);
                valuesArr = [];

                    const route = result.routes[0].legs[0];
                    const totalDistance = route.distance.value; // in meters

                    // Specify the number of waypoints you want
                    const numWaypoints = 20;
                    const interval = totalDistance / numWaypoints;

                    // Calculate and extract evenly spaced waypoints
                    for (let i = 0; i < numWaypoints; i++) {
                    const distanceAlongRoute = i * interval;
                    const location = getWaypointLocation(route, distanceAlongRoute);
                    valuesArr.push(location);
                    }
                    resolve(valuesArr);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            })
        });
            }

        function calculateMeanAndDisplay(routes, exArr, maxJ){
            let arrMean = [];
            let total = 0;
            var container = document.getElementById("dynamicContentContainer");
            var colourArr = ['Red', 'Blue', 'Yellow'];

            for (let i = 0; i < routes.length; i++) {
                let compArr = 0;

                for (let j = 0; j < Math.min(routes[i].length, maxJ); j++){
                    const latArray = routes[i].map(({ lat }) => lat);
                    const lngArray = routes[i].map(({ lng }) => lng);
                    const exLatArray = exArr.map(({ lat }) => lat);
                    const exLngArray = exArr.map(({ lng }) => lng);
                    let part1 = Math.abs(latArray[j] - exLatArray[j]);
                    let part2 = Math.abs(lngArray[j] - exLngArray[j]);
                    compArr = compArr + part1 + part2;

                }
                total += compArr;
                arrMean.push(compArr);
            };
            // container.innerHTML = "";
            for (let index = 0; index < arrMean.length; index++) {
                let mean = (arrMean[index]/total).toFixed(2);
                var paragraph = document.createElement("p");
                paragraph.textContent = colourArr[index] + ": " + mean;
                container.appendChild(paragraph);

            }
        }
        
        async function caller(){
            let arr1 = await displayRoute('Picadilly Station', 'red');
            let arr2 = await addMarkersFromFile();
            let arr3 = await displayRoute('Gay village', 'yellow');
            let exArr = await displayRoute(document.getElementById('end').value, 'orange');  

            console.log(arr1);
            console.log(exArr);
            let routes = [arr1, arr2, arr3];

            calculateMeanAndDisplay(routes, exArr, 2);
            setTimeout(3000);
            calculateMeanAndDisplay(routes, exArr, 5);
            setTimeout(3000);
            calculateMeanAndDisplay(routes, exArr, 10);
            setTimeout(3000);
            calculateMeanAndDisplay(routes, exArr, 20);

        }

        document.getElementById('route-form').addEventListener('submit', function (e) {
            e.preventDefault();
            caller();
        });
    </script>
</body>
</html>